<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Story Tests Runner</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #1a1a1a 0%, #2c2c2c 100%);
            color: #e0e0e0;
            min-height: 100vh;
            line-height: 1.6;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #3a3a3a 0%, #2e2e2e 100%);
            border-radius: 8px;
            border: 1px solid #4a4a4a;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            color: #f0f0f0;
        }
        
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1em;
            color: #c0c0c0;
        }
        
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        
        button {
            background: linear-gradient(135deg, #4a4a4a 0%, #3a3a3a 100%);
            color: #e0e0e0;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin: 0 10px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            border: 1px solid #5a5a5a;
        }
        
        .test-suite-btn {
            background: linear-gradient(135deg, #4a4a4a 0%, #3a3a3a 100%);
            margin: 5px;
        }
        
        .test-suite-btn:hover {
            background: linear-gradient(135deg, #5a5a5a 0%, #4a4a4a 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            border-color: #6a6a6a;
        }
        
        .test-suite-btn.active {
            background: linear-gradient(135deg, #5a5a5a 0%, #4a4a4a 100%);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            border-color: #7a7a7a;
        }
        
        button:hover {
            background: linear-gradient(135deg, #5a5a5a 0%, #4a4a4a 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            border-color: #6a6a6a;
        }
        
        button:disabled {
            background: #2a2a2a;
            color: #808080;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            border-color: #3a3a3a;
        }
        
        .test-output {
            background: #2a2a2a;
            border: 1px solid #404040;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            min-height: 400px;
            white-space: pre-wrap;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.5;
            overflow-y: auto;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .results-summary {
            background: linear-gradient(135deg, #333333 0%, #2a2a2a 100%);
            border: 1px solid #4a4a4a;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            display: none;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .results-summary.success {
            background: linear-gradient(135deg, #3a4a3a 0%, #2a3a2a 100%);
            border-color: #4a5a4a;
        }
        
        .results-summary.failure {
            background: linear-gradient(135deg, #4a3a3a 0%, #3a2a2a 100%);
            border-color: #5a4a4a;
        }
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
        }
        
        .results-summary h3 {
            margin: 0 0 15px 0;
            font-size: 1.5em;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .result-item {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }
        
        .result-item .value {
            font-size: 1.8em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .result-item .label {
            font-size: 0.9em;
            opacity: 0.8;
        }
        
        .test-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .category {
            background: #343a40;
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid #007bff;
        }
        
        .category h3 {
            margin: 0 0 10px 0;
            color: #007bff;
        }
        
        .category ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .category li {
            margin: 5px 0;
            opacity: 0.9;
        }
        
        .spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background: #dc3545;
            color: white;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
            display: none;
        }
        
        .story-selection {
            background: #343a40;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }
        
        .story-selection h3 {
            margin: 0 0 15px 0;
            color: #ffc107;
        }
        
        .story-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        
        .story-card {
            background: #495057;
            padding: 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .story-card:hover {
            background: #6c757d;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .story-card.selected {
            border-color: #28a745;
            background: #20c997;
            color: white;
        }
        
        .story-card h4 {
            margin: 0 0 10px 0;
            font-size: 1.2em;
        }
        
        .story-card p {
            margin: 0;
            opacity: 0.8;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üß™ Interactive Story Tests Runner</h1>
        <p>Comprehensive testing suite for RPG mechanics, type effectiveness, environmental effects, status effects, and story systems</p>
    </div>

    <div class="test-categories" id="test-categories">
        <div class="category">
            <h3>üß™ Select a Test Suite</h3>
            <ul>
                <li>Choose a test suite above to see what will be tested</li>
                <li>Battle System: Combat mechanics, damage, accuracy</li>
                <li>Type Effectiveness: Elemental interactions and multipliers</li>
                <li>Story Nodes: Interactive choices, dice rolls, environmental effects</li>
                <li>Environmental Effects: Weather and terrain impacts</li>
                <li>Status Effects: Flying, pinned, poison, burn, stun mechanics</li>
            </ul>
        </div>
    </div>

    <div class="controls">
        <button id="test-battle" class="test-suite-btn">‚öîÔ∏è Test Battle System</button>
        <button id="test-types" class="test-suite-btn">üî• Test Type Effectiveness</button>
        <button id="test-story-nodes" class="test-suite-btn">üìñ Test Story Nodes</button>
        <button id="test-environmental" class="test-suite-btn">üåç Test Environmental Effects</button>
        <button id="test-status-effects" class="test-suite-btn">üß™ Test Status Effects</button>
        <button id="clear-output">üßπ Clear Output</button>
        <div class="spinner" id="spinner"></div>
    </div>

    <div class="error-message" id="error-message"></div>

    <div class="story-selection" id="story-selection">
        <h3>üìö Select Story to Test</h3>
        <p>Choose which story system you want to test:</p>
        <div class="story-grid" id="story-grid">
            <!-- Stories will be loaded dynamically -->
        </div>
        <div style="text-align: center; margin-top: 20px;">
            <button id="run-selected-story-tests" disabled>üöÄ Run Tests for Selected Story</button>
        </div>
    </div>

    <div class="results-summary" id="results-summary">
        <h3>üìä Test Results</h3>
        <div class="results-grid">
            <div class="result-item">
                <div class="value" id="passed-count">0</div>
                <div class="label">Passed</div>
            </div>
            <div class="result-item">
                <div class="value" id="failed-count">0</div>
                <div class="label">Failed</div>
            </div>
            <div class="result-item">
                <div class="value" id="total-count">0</div>
                <div class="label">Total</div>
            </div>
            <div class="result-item">
                <div class="value" id="success-rate">0%</div>
                <div class="label">Success Rate</div>
            </div>
        </div>
    </div>

    <div class="test-output" id="test-output">
        Welcome to the Interactive Story Tests Runner! üß™
        
        Choose a test suite to run:
        ‚Ä¢ ‚öîÔ∏è Battle System: Combat mechanics, damage calculations, accuracy
        ‚Ä¢ üî• Type Effectiveness: Elemental interactions and multipliers
        ‚Ä¢ üìñ Story Nodes: Interactive choices, dice rolls, environmental effects, rewards
        ‚Ä¢ üåç Environmental Effects: Weather, terrain, type interactions, intensity levels
        ‚Ä¢ üß™ Status Effects: Flying, pinned, poison, burn, stun, and type interactions
        
        Select a test suite above to begin testing!
        ‚Ä¢ üåç Environmental Effects: Weather and terrain impact testing
        
        Select a test suite above to see detailed information and run tests! üöÄ
    </div>

    <script type="module">
        import { BattleSystemTests } from './battle-tests.js';
        import { TypeEffectivenessTests } from './type-effectiveness-tests.js';
        import { StoryTypeEffectivenessTests } from './story-type-tests.js';
        import { StoryNodeTests } from './story-node-tests.js';
        import { EnvironmentalEffectsTests } from './environmental-effects-tests.js';
        import { runStatusEffectsTests } from './status-effects-tests.js';
        
        let currentTestRunner = null;
        let currentSuite = null;
        let selectedStory = null;
        let availableStories = [];
        
        // Available stories configuration
        const storyConfigs = {
            'story01-battle-st': {
                name: 'Battle Story',
                description: 'Combat-focused story with elemental types',
                folder: 'story01-battle-st'
            }
        };
        
        // Test suite configurations
        const testSuites = {
            battle: {
                name: 'Battle System',
                icon: '‚öîÔ∏è',
                description: 'Combat mechanics, damage calculations, and battle flow',
                requiresStory: false,
                categories: [
                    {
                        title: 'üó°Ô∏è Damage System',
                        tests: [
                            'Basic damage calculation',
                            'Type effectiveness integration',
                            'Defense and armor calculations',
                            'Size and weight modifiers',
                            'Critical hit multipliers'
                        ]
                    },
                    {
                        title: 'üéØ Accuracy System',
                        tests: [
                            'Base accuracy calculation',
                            'Speed-based hit chance',
                            'Size-based targeting',
                            'Environmental penalties'
                        ]
                    },
                    {
                        title: 'üåç Environmental Integration',
                        tests: [
                            'Volcanic heat immunity',
                            'Underwater movement penalties',
                            'Storm lightning strikes',
                            'Cave darkness effects'
                        ]
                    },
                    {
                        title: '‚öîÔ∏è Battle Flow',
                        tests: [
                            'Character initialization',
                            'Ability costs and cooldowns',
                            'Status effect application',
                            'Win/loss conditions'
                        ]
                    }
                ],
                runner: () => new BattleSystemTests()
            },
            types: {
                name: 'Type Effectiveness',
                icon: 'üî•',
                description: 'Story-specific elemental type interactions and damage multipliers',
                requiresStory: true,
                categories: [
                    {
                        title: 'üîç Dynamic Type Analysis',
                        tests: [
                            'Load all types from selected story',
                            'Test all type vs type combinations',
                            'Validate immunity mechanics',
                            'Verify resistance calculations',
                            'Check weakness multipliers'
                        ]
                    },
                    {
                        title: 'üìä Coverage Analysis',
                        tests: [
                            'Ensure all types have combat properties',
                            'Check for balanced type relationships',
                            'Validate multiplier ranges (0.0 - 3.0)',
                            'Test edge cases and invalid inputs'
                        ]
                    }
                ],
                runner: async (storyFolder) => {
                    const testSuite = new StoryTypeEffectivenessTests(storyFolder);
                    await testSuite.initialize();
                    return testSuite;
                }
            },
            'story-nodes': {
                name: 'Story Nodes',
                icon: 'üìñ',
                description: 'Interactive story mechanics: choices, dice rolls, environmental effects, rewards',
                requiresStory: true,
                categories: [
                    {
                        title: 'üó∫Ô∏è Basic Node Navigation',
                        tests: [
                            'Node structure validation',
                            'Choice navigation logic',
                            'Scenario switching mechanics',
                            'Loaded scenario validation'
                        ]
                    },
                    {
                        title: 'üéØ Choice Processing',
                        tests: [
                            'Basic choice processing',
                            'Life changes and healing',
                            'Damage calculation with defense',
                            'Item rewards distribution',
                            'EXP rewards integration'
                        ]
                    },
                    {
                        title: 'üé≤ Dice Roll Mechanics',
                        tests: [
                            'Dice roll generation (1-20)',
                            'Attribute bonus calculation',
                            'Outcome determination logic',
                            'Item rewards from dice',
                            'Multiple outcome scenarios'
                        ]
                    },
                    {
                        title: 'üåç Environmental Effects',
                        tests: [
                            'Environmental damage processing',
                            'Chance-based damage events',
                            'Type immunity to environments',
                            'Scenario environmental validation'
                        ]
                    },
                    {
                        title: '‚öîÔ∏è Damage & Healing',
                        tests: [
                            'Damage calculation with defense',
                            'Healing caps at max life',
                            'Damage caps at 0 life',
                            'Environmental damage types'
                        ]
                    },
                    {
                        title: 'üéÅ Item & Reward Systems',
                        tests: [
                            'Item addition to inventory',
                            'EXP reward processing',
                            'Multiple reward type handling',
                            'Scenario item reference validation'
                        ]
                    },
                    {
                        title: '‚öîÔ∏è Battle Integration',
                        tests: [
                            'Battle trigger processing',
                            'Battle environment setup',
                            'Scenario battle configuration'
                        ]
                    },
                    {
                        title: '‚úÖ Node Validation',
                        tests: [
                            'Required property validation',
                            'Invalid node detection',
                            'Choice validation logic',
                            'Loaded scenario validation'
                        ]
                    }
                ],
                runner: async (storyFolder) => {
                    const testSuite = new StoryNodeTests(storyFolder);
                    await testSuite.initialize();
                    return testSuite;
                }
            },
            environmental: {
                name: 'Environmental Effects',
                icon: 'üåç',
                description: 'Story-specific environmental systems: weather, terrain, type interactions, intensity levels',
                requiresStory: true,
                categories: [
                    {
                        title: 'üìÅ Environment Loading',
                        tests: [
                            'Environment manifest loading',
                            'Environment file loading',
                            'Environment structure validation',
                            'Environment data consistency'
                        ]
                    },
                    {
                        title: 'üèóÔ∏è Basic Properties',
                        tests: [
                            'Required environment properties',
                            'Temperature setting validation',
                            'Default intensity levels',
                            'Environment naming consistency'
                        ]
                    },
                    {
                        title: 'üìä Intensity Systems',
                        tests: [
                            'Intensity level structure validation',
                            'Escalating effects by intensity',
                            'Intensity-specific messages',
                            'Reasonable intensity ranges'
                        ]
                    },
                    {
                        title: 'üî• Type Interactions',
                        tests: [
                            'Type damage multiplier validation',
                            'Type interaction descriptions',
                            'Immunity system configuration',
                            'Logical type relationships'
                        ]
                    },
                    {
                        title: '‚ö° Environmental Effects',
                        tests: [
                            'Environmental damage validation',
                            'Penalty effect ranges',
                            'Damage type validation',
                            'Effect scaling by intensity'
                        ]
                    },
                    {
                        title: '‚öîÔ∏è Combat Modifiers',
                        tests: [
                            'Combat modifier ranges',
                            'Logical ability modifiers',
                            'Damage bonus/reduction validation',
                            'Accuracy modifier validation'
                        ]
                    },
                    {
                        title: 'üåü Status Effects',
                        tests: [
                            'Status effect chance validation',
                            'Valid status effect types',
                            'Status effect consistency',
                            'Reasonable status chances'
                        ]
                    },
                    {
                        title: 'ÔøΩ Environmental Messages',
                        tests: [
                            'Descriptive effect messages',
                            'Type interaction messages',
                            'Contextually relevant messages',
                            'Message length validation'
                        ]
                    },
                    {
                        title: 'üßÆ Damage Calculations',
                        tests: [
                            'Environmental damage calculations',
                            'Type multiplier applications',
                            'Intensity damage scaling',
                            'Damage range validation'
                        ]
                    },
                    {
                        title: '‚úÖ Environment Validation',
                        tests: [
                            'Unique environment IDs',
                            'Environment completeness',
                            'Data consistency checks',
                            'Overall system validation'
                        ]
                    }
                ],
                runner: async (storyFolder) => {
                    const testSuite = new EnvironmentalEffectsTests(storyFolder);
                    await testSuite.initialize();
                    return testSuite;
                }
            },
            'status-effects': {
                name: 'Status Effects',
                icon: 'üß™',
                description: 'Comprehensive testing for status effects including flying, pinned, poison, burn, stun, and type interactions',
                requiresStory: true,
                categories: [
                    {
                        title: 'üéØ Status Application',
                        tests: [
                            'Basic status application',
                            'Status removal mechanics',
                            'Turn duration handling',
                            'Permanent status effects'
                        ]
                    },
                    {
                        title: '‚è±Ô∏è Status Ticks',
                        tests: [
                            'Tick function execution',
                            'Turn countdown mechanics',
                            'Status expiration logic',
                            'Permanent status handling'
                        ]
                    },
                    {
                        title: 'ü¶Ö Flying Mechanics',
                        tests: [
                            'Speed boost application',
                            'Immunity to close attacks',
                            'Diving attack multipliers',
                            'Fall damage from ranged hits',
                            'Landing mechanics'
                        ]
                    },
                    {
                        title: 'üìå Pinned Mechanics',
                        tests: [
                            'Movement restriction',
                            'Speed penalties',
                            'Duration and removal',
                            'Type-based interactions'
                        ]
                    },
                    {
                        title: 'üî• Type Interactions',
                        tests: [
                            'Fire type immunity to burn',
                            'Water type immunities',
                            'Earth type resistances',
                            'Air type flying bonuses',
                            'Status immunity messages'
                        ]
                    },
                    {
                        title: 'üíä Other Status Effects',
                        tests: [
                            'Poison damage over time',
                            'Burn continuous damage',
                            'Stun movement blocking',
                            'Frozen action prevention'
                        ]
                    }
                ],
                runner: async (storyFolder) => {
                    // Create a wrapper that matches the expected interface
                    return {
                        runTests: async () => {
                            // Create a mock output element
                            const mockOutput = {
                                innerHTML: '',
                                textContent: ''
                            };
                            
                            // Run the status effects tests
                            const results = await runStatusEffectsTests(storyFolder, mockOutput);
                            
                            // Output the results to console (which gets captured by the main runner)
                            console.log(mockOutput.innerHTML);
                            
                            // Return results in the expected format
                            return {
                                passed: results ? results.passedTests : 0,
                                failed: results ? results.failedTests : 0,
                                total: results ? results.totalTests : 0,
                                results: results
                            };
                        }
                    };
                }
            }
        };
        
        async function loadAvailableStories() {
            try {
                const stories = [];
                
                for (const [key, config] of Object.entries(storyConfigs)) {
                    try {
                        const typesUrl = `../../story-content/${config.folder}/types/_types.json?v=${Date.now()}`;
                        const response = await fetch(typesUrl);
                        if (response.ok) {
                            const typesManifest = await response.json();
                            stories.push({
                                key,
                                name: config.name,
                                description: config.description,
                                folder: config.folder,
                                typesCount: typesManifest.length
                            });
                        }
                    } catch (error) {
                        console.log(`Story ${config.name} not available or no types found`);
                    }
                }
                
                availableStories = stories;
                return stories;
            } catch (error) {
                console.error('Error loading stories:', error);
                return [];
            }
        }
        
        function displayStories() {
            const storyGrid = document.getElementById('story-grid');
            
            if (availableStories.length === 0) {
                storyGrid.innerHTML = `
                    <div class="story-card" style="grid-column: 1 / -1; text-align: center; cursor: default;">
                        <h4>‚ö†Ô∏è No Stories Found</h4>
                        <p>No stories with type systems were found in the story-content folder.</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            availableStories.forEach(story => {
                html += `
                    <div class="story-card" data-story="${story.key}">
                        <h4>üìñ ${story.name}</h4>
                        <p>${story.description}</p>
                        <p><strong>${story.typesCount}</strong> types available</p>
                    </div>
                `;
            });
            
            storyGrid.innerHTML = html;
            
            // Add click handlers to story cards
            document.querySelectorAll('.story-card[data-story]').forEach(card => {
                card.addEventListener('click', () => {
                    document.querySelectorAll('.story-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    selectedStory = card.dataset.story;
                    document.getElementById('run-selected-story-tests').disabled = false;
                });
            });
        }
        
        function updateTestCategories(suiteKey) {
            const categoriesDiv = document.getElementById('test-categories');
            const suite = testSuites[suiteKey];
            
            if (!suite) return;
            
            let html = '';
            suite.categories.forEach(category => {
                html += `
                    <div class="category">
                        <h3>${category.title}</h3>
                        <ul>
                            ${category.tests.map(test => `<li>${test}</li>`).join('')}
                        </ul>
                    </div>
                `;
            });
            
            categoriesDiv.innerHTML = html;
        }
        
        function setActiveButton(activeId) {
            document.querySelectorAll('.test-suite-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(activeId).classList.add('active');
        }
        
        function updateOutput(message) {
            const output = document.getElementById('test-output');
            output.textContent = message;
        }
        
        function showStorySelection() {
            document.getElementById('story-selection').style.display = 'block';
            document.getElementById('results-summary').style.display = 'none';
        }
        
        function hideStorySelection() {
            document.getElementById('story-selection').style.display = 'none';
        }
        
        async function runTestSuite(suiteKey) {
            const suite = testSuites[suiteKey];
            const runButton = document.getElementById(`test-${suiteKey}`);
            const spinner = document.getElementById('spinner');
            const output = document.getElementById('test-output');
            const errorDiv = document.getElementById('error-message');
            const resultsDiv = document.getElementById('results-summary');
            
            // Hide story selection when running tests
            hideStorySelection();
            
            if (!suite.runner || (typeof suite.runner === 'function' && !suite.runner())) {
                updateOutput(`${suite.icon} ${suite.name} tests are not yet implemented.\n\nComing soon! This test suite will cover:\n${suite.description}\n\nCurrently available: Battle System and Type Effectiveness tests`);
                return;
            }
            
            // Show loading state
            runButton.disabled = true;
            spinner.style.display = 'block';
            errorDiv.style.display = 'none';
            resultsDiv.style.display = 'none';
            output.textContent = `Running ${suite.name} tests...\n\n`;
            
            try {
                // Redirect console.log to our output div
                const originalLog = console.log;
                console.log = function(...args) {
                    output.textContent += args.join(' ') + '\n';
                    output.scrollTop = output.scrollHeight;
                    originalLog.apply(console, args);
                };
                
                // Create and run tests
                let testRunner;
                if (suite.requiresStory && selectedStory) {
                    const storyConfig = storyConfigs[selectedStory];
                    testRunner = await suite.runner(storyConfig.folder);
                } else {
                    testRunner = suite.runner();
                }
                
                currentTestRunner = testRunner;
                const results = await testRunner.runTests();
                
                // Restore console.log
                console.log = originalLog;
                
                // Show results summary
                updateResultsSummary(results);
                resultsDiv.style.display = 'block';
                
                // Style results div based on success
                if (results.failed === 0) {
                    resultsDiv.className = 'results-summary success';
                } else {
                    resultsDiv.className = 'results-summary failure';
                }
                
            } catch (error) {
                console.error('Test execution error:', error);
                errorDiv.textContent = `Test execution failed: ${error.message}`;
                errorDiv.style.display = 'block';
                output.textContent += `\n‚ùå ERROR: ${error.message}\n`;
            } finally {
                // Reset UI
                runButton.disabled = false;
                spinner.style.display = 'none';
            }
        }
        
        function clearOutput() {
            document.getElementById('test-output').textContent = 'Output cleared. Select a test suite to run tests!\n';
            document.getElementById('results-summary').style.display = 'none';
            document.getElementById('error-message').style.display = 'none';
            hideStorySelection();
        }
        
        function updateResultsSummary(results) {
            document.getElementById('passed-count').textContent = results.passed;
            document.getElementById('failed-count').textContent = results.failed;
            document.getElementById('total-count').textContent = results.total;
            document.getElementById('success-rate').textContent = 
                Math.round((results.passed / results.total) * 100) + '%';
        }
        
        // Initialize on load and bind event handlers
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Comprehensive Test Suite loaded and ready!');
            
            // Load available stories
            await loadAvailableStories();
            
            // Bind test suite buttons
            document.getElementById('test-battle').addEventListener('click', () => {
                if (currentSuite === 'battle') {
                    runTestSuite('battle');
                } else {
                    setActiveButton('test-battle');
                    updateTestCategories('battle');
                    hideStorySelection();
                    updateOutput(`${testSuites.battle.icon} Battle System Test Suite Selected\n\n${testSuites.battle.description}\n\nClick this button again to run the tests!`);
                    currentSuite = 'battle';
                }
            });
            
            document.getElementById('test-types').addEventListener('click', async () => {
                if (currentSuite === 'types' && selectedStory) {
                    runTestSuite('types');
                } else {
                    setActiveButton('test-types');
                    updateTestCategories('types');
                    
                    if (availableStories.length === 0) {
                        updateOutput(`${testSuites.types.icon} Type Effectiveness Test Suite\n\n‚ùå No stories with type systems found!\n\nMake sure you have stories in the story-content folder with types/ directories.`);
                    } else {
                        showStorySelection();
                        displayStories();
                        updateOutput(`${testSuites.types.icon} Type Effectiveness Test Suite Selected\n\n${testSuites.types.description}\n\nSelect a story below to test its type system!`);
                    }
                    currentSuite = 'types';
                }
            });
            
            document.getElementById('test-story-nodes').addEventListener('click', async () => {
                if (currentSuite === 'story-nodes' && selectedStory) {
                    runTestSuite('story-nodes');
                } else {
                    setActiveButton('test-story-nodes');
                    updateTestCategories('story-nodes');
                    
                    if (availableStories.length === 0) {
                        updateOutput(`${testSuites['story-nodes'].icon} Story Node Test Suite\n\n‚ùå No stories found!\n\nMake sure you have stories in the story-content folder with scenarios/ directories.`);
                    } else {
                        showStorySelection();
                        displayStories();
                        updateOutput(`${testSuites['story-nodes'].icon} Story Node Test Suite Selected\n\n${testSuites['story-nodes'].description}\n\nSelect a story below to test its interactive mechanics!`);
                    }
                    currentSuite = 'story-nodes';
                }
            });
            
            document.getElementById('test-environmental').addEventListener('click', () => {
                if (currentSuite === 'environmental' && selectedStory) {
                    runTestSuite('environmental');
                } else {
                    setActiveButton('test-environmental');
                    updateTestCategories('environmental');
                    
                    if (availableStories.length === 0) {
                        updateOutput(`${testSuites.environmental.icon} Environmental Effects Test Suite\n\n‚ùå No stories found!\n\nMake sure you have stories in the story-content folder with environmentalEffects/ directories.`);
                    } else {
                        showStorySelection();
                        displayStories();
                        updateOutput(`${testSuites.environmental.icon} Environmental Effects Test Suite Selected\n\n${testSuites.environmental.description}\n\nSelect a story below to test its environmental systems!`);
                    }
                    currentSuite = 'environmental';
                }
            });
            
            document.getElementById('test-status-effects').addEventListener('click', () => {
                if (currentSuite === 'status-effects' && selectedStory) {
                    runTestSuite('status-effects');
                } else {
                    setActiveButton('test-status-effects');
                    updateTestCategories('status-effects');
                    
                    if (availableStories.length === 0) {
                        updateOutput(`üß™ Status Effects Test Suite\n\n‚ùå No stories found!\n\nMake sure you have stories in the story-content folder with statuses/ directories.`);
                    } else {
                        showStorySelection();
                        displayStories();
                        updateOutput(`üß™ Status Effects Test Suite Selected\n\nComprehensive testing for status effects including flying, pinned, poison, burn, stun, and type interactions.\n\nSelect a story below to test its status effects!`);
                    }
                    currentSuite = 'status-effects';
                }
            });
            
            // Bind run selected story tests button
            document.getElementById('run-selected-story-tests').addEventListener('click', () => {
                if (selectedStory) {
                    if (currentSuite === 'types') {
                        runTestSuite('types');
                    } else if (currentSuite === 'story-nodes') {
                        runTestSuite('story-nodes');
                    } else if (currentSuite === 'environmental') {
                        runTestSuite('environmental');
                    } else if (currentSuite === 'status-effects') {
                        runTestSuite('status-effects');
                    }
                }
            });
            
            // Bind clear button
            document.getElementById('clear-output').addEventListener('click', clearOutput);
        });
    </script>
</body>
</html>
